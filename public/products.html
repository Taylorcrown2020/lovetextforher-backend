<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products ‚Äî LoveTextForHer</title>

<script src="/config.js"></script>

    <style>
        :root {
            --primary: #d6336c;
            --secondary: #8b5cf6;
            --text-dark: #1a1a1a;
            --text-soft: #5f3a4d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", sans-serif;
            background: linear-gradient(135deg, #fff7fa, #f6f3ff);
            overflow-x: hidden;
        }

        /* ================= MOBILE MENU ================= */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top:20px;
            right: 10px;
            z-index: 1000;
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
        }

        .mobile-menu-btn span {
            display: block;
            width: 28px;
            height: 3px;
            background: var(--text-dark);
            margin: 5px 0;
            transition: 0.3s;
            border-radius: 2px;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-6px, 6px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(45deg) translate(-6px, -6px);
        }

        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 10px;
            right: -100%;
            width: 100%;
            height: 100vh;
            background: #fff;
            z-index: 999;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }

        .mobile-nav-overlay.active {
            right: 0;
        }

        .mobile-nav-content {
            padding: 80px 30px 40px;
        }

        .mobile-nav-links {
            list-style: none;
            margin-bottom: 40px;
        }

        .mobile-nav-links li {
            margin-bottom: 30px;
        }

        .mobile-nav-links a {
            color: var(--text-dark);
            text-decoration: none;
            font-size: 20px;
            font-weight: 600;
            display: block;
            padding: 10px 0;
            transition: color 0.2s;
        }

        .mobile-nav-links a:hover {
            color: var(--primary);
        }

        #navbar { 
            width: 100%; 
            height: 95px; 
        }

        .product-section {
            max-width: 1200px;
            margin: 120px auto 60px;
        }

        .header-container {
            text-align: center;
            margin-bottom: 50px;
            padding: 0 20px;
        }

        .header-subtitle {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }

        .product-title {
            font-size: 42px;
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 12px;
            line-height: 1.2;
        }

        .header-description {
            font-size: 16px;
            color: #6b7280;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 32px;
            margin-top: 40px;
            padding: 0 20px;
        }

        /* ================= SUBSCRIPTION CARDS ================= */
        .card {
            background: white;
            border-radius: 20px;
            padding: 32px 24px;
            border: 2px solid #e5e7eb;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card.subscription-card {
            padding: 28px 24px 32px;
        }

        .card.featured {
            background: linear-gradient(135deg, #d6336c 0%, #e91e8c 100%);
            border-color: #d6336c;
            transform: scale(1.03);
        }

        .card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
        }

        .card.featured:hover {
            transform: scale(1.05) translateY(-4px);
        }

        .badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--primary);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .featured-banner {
            background: #d6336c;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin: -28px -24px 20px;
            border-radius: 18px 18px 0 0;
        }

        .plan-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .card.featured .plan-name {
            color: white;
        }

        .plan-description {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .card.featured .plan-description {
            color: rgba(255,255,255,0.9);
        }

        .price-container {
            margin-bottom: 20px;
        }

        .price-main {
            display: flex;
            align-items: baseline;
            gap: 4px;
            margin-bottom: 8px;
        }

        .currency {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .card.featured .currency {
            color: white;
        }

        .amount {
            font-size: 48px;
            font-weight: 800;
            line-height: 1;
            color: var(--text-dark);
        }

        .card.featured .amount {
            color: white;
        }

        .period {
            font-size: 18px;
            color: #6b7280;
            font-weight: 500;
        }

        .card.featured .period {
            color: rgba(255,255,255,0.9);
        }

        .bonus-text {
            color: #ffc0d4;
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .card.featured .bonus-text {
            color: #ffc0d4;
        }

        .price-details {
            font-size: 12px;
            color: #9ca3af;
            line-height: 1.4;
        }

        .card.featured .price-details {
            color: rgba(255,255,255,0.7);
        }

        /* ================= MERCH CARDS ================= */
        .card.merch-card {
            padding: 20px;
            background: white;
        }

        .image-container {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            margin-bottom: 20px;
        }

        .single-image {
            width: 100%;
            height: 280px;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .card.merch-card:hover .single-image {
            transform: scale(1.05);
        }

        .dual-images {
            display: flex;
            gap: 8px;
        }

        .dual-images img {
            width: 50%;
            height: 280px;
            object-fit: cover;
            border-radius: 12px;
            transition: transform 0.4s ease;
        }

        .card.merch-card:hover .dual-images img {
            transform: scale(1.03);
        }

        .product-tag {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .name {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-dark);
            line-height: 1.3;
        }

        .price {
            font-size: 18px;
            color: var(--text-dark);
            margin-bottom: 16px;
            font-weight: 700;
        }

        .price-original {
            color: #9ca3af;
            text-decoration: line-through;
            font-size: 15px;
            font-weight: 500;
            margin-left: 8px;
        }

        .product-billing {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
            font-weight: 500;
        }

        /* ================= BUTTONS ================= */
        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            text-transform: capitalize;
            letter-spacing: 0.3px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-subscribe {
            background: white;
            color: var(--text-dark);
            border: 2px solid #e5e7eb;
        }

        .btn-subscribe:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .card.featured .btn-subscribe {
            background: #1a1a1a;
            color: white;
            border: none;
        }

        .card.featured .btn-subscribe:hover {
            background: #2d2d2d;
        }

        .btn-add {
            background: linear-gradient(90deg, #8b5cf6, #d6336c);
            color: white;
        }

        .btn-add:hover {
            box-shadow: 0 4px 12px rgba(139,92,246,0.3);
        }

        .btn-disabled {
            background: #e5e7eb !important;
            cursor: not-allowed !important;
            color: #9ca3af !important;
            border: none !important;
        }

        .features-list {
            margin: 24px 0;
            padding: 0;
            list-style: none;
        }

        .features-list li {
            padding: 10px 0;
            font-size: 14px;
            color: #4b5563;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card.featured .features-list li {
            color: rgba(255,255,255,0.95);
        }

        .features-list li:before {
            content: "‚óè";
            color: var(--text-dark);
            font-weight: bold;
            font-size: 10px;
        }

        .card.featured .features-list li:before {
            color: #ffc0d4;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 18px;
            color: var(--text-soft);
        }

        /* ============== MOBILE ============== */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .mobile-nav-overlay {
                display: block;
            }

            #navbar {
                display: none !important;
            }

            body {
                padding-top: 60px;
            }

            .product-section {
                margin: 30px auto 40px;
            }

            .header-container {
                margin-bottom: 35px;
            }

            .header-subtitle {
                font-size: 12px;
                letter-spacing: 1.5px;
            }

            .product-title {
                font-size: 32px;
                padding: 0 20px;
                margin-bottom: 10px;
            }

            .header-description {
                font-size: 15px;
                padding: 0 20px;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-top: 30px;
                padding: 0 16px;
            }

            .card {
                padding: 24px 20px;
                border-radius: 16px;
            }

            .card.subscription-card {
                padding: 24px 20px 28px;
            }

            .card.featured {
                transform: scale(1);
            }

            .featured-banner {
                margin: -24px -20px 16px;
            }

            .badge {
                top: 12px;
                right: 12px;
                padding: 5px 14px;
                font-size: 12px;
            }

            .plan-name {
                font-size: 22px;
            }

            .amount {
                font-size: 42px;
            }

            .single-image {
                height: 240px;
            }

            .dual-images img {
                height: 240px;
            }

            .name {
                font-size: 20px;
            }

            .price {
                font-size: 17px;
            }

            .btn {
                padding: 15px 14px;
                font-size: 15px;
            }
        }

        @media (min-width: 1200px) {
            .grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>

<body>

<button class="mobile-menu-btn" onclick="toggleMobileMenu()">
    <span></span>
    <span></span>
    <span></span>
</button>

<div class="mobile-nav-overlay" id="mobileNav">
    <div class="mobile-nav-content">
        <ul class="mobile-nav-links">
            <li><a href="#" onclick="switchView('recipients'); closeMobileMenu(); return false;">Recipients</a></li>
            <li><a href="#" onclick="switchView('settings'); closeMobileMenu(); return false;">Settings</a></li>
            <li><a href="/products.html" onclick="closeMobileMenu()">Products</a></li>
            <li><a href="/cart.html" onclick="closeMobileMenu()">Cart</a></li>
            <li><a href="#" onclick="handleLogout(event); closeMobileMenu(); return false;">Logout</a></li>
        </ul>
    </div>
</div>

<div id="navbar"></div>
<script src="/js/nav.js" defer></script>

<div class="product-section">
    <div class="header-container">
        <div class="header-subtitle">Premium Plans</div>
        <h1 class="product-title">Choose Your Subscription</h1>
        <p class="header-description">Select the perfect plan to help you express your love with personalized messages and romantic content</p>
    </div>
    <div class="grid" id="productGrid">
        <div class="loading">Loading products...</div>
    </div>
</div>

<script>

function toggleMobileMenu() {
    const btn = document.querySelector('.mobile-menu-btn');
    const nav = document.getElementById('mobileNav');
    const body = document.body;
    
    btn.classList.toggle('active');
    nav.classList.toggle('active');
    
    if (nav.classList.contains('active')) {
        body.style.overflow = 'hidden';
    } else {
        body.style.overflow = '';
    }
}

function closeMobileMenu() {
    const btn = document.querySelector('.mobile-menu-btn');
    const nav = document.getElementById('mobileNav');
    const body = document.body;
    
    btn.classList.remove('active');
    nav.classList.remove('active');
    body.style.overflow = '';
}

async function handleLogout(event) {
    if (event) event.preventDefault();
    
    try {
        await fetch("/api/customer/logout", {
            method: "POST",
            credentials: "include"
        });
        
        sessionStorage.clear();
        window.location.href = "/login.html";
    } catch (err) {
        console.error("Logout error:", err);
        window.location.href = "/login.html";
    }
}

const PRODUCTS = {
    "free-trial": {
        id: "free-trial",
        name: "Free Trial",
        description: "Try our basic features for 3 days",
        price: 0.00,
        billing: "3-Day Trial",
        subscription: true,
        badge: "Free",
        features: ["Up to 8 recipiants", "Advanced features", "Advanced Scheduling", "3-day access"]
    },
    "love-basic": {
        id: "love-basic",
        name: "Basic Subscription",
        description: "Get the essentials for romantic messages",
        price: 2.99,
        billing: "Monthly Subscription",
        subscription: true,
        badge: "Popular",
        features: ["Up to 3 recipiants", "Advanced Scheduling"]
    },
    "love-plus": {
        id: "love-plus",
        name: "Plus Subscription",
        description: "Unlock premium features and unlimited messages",
        price: 6.99,
        billing: "Monthly Subscription",
        subscription: true,
        badge: "Best Value",
        featured: true,
        features: ["Up to 8 recipiants", "Advanced features", "Advanced Scheduling"]
    }
};

async function getSubscription() {
    try {
        const res = await fetch("/api/customer/subscription", {
            credentials: "include",
            cache: "no-store"
        });

        if (!res.ok) return null;
        const data = await res.json();
        
        // ‚úÖ DEBUG: Log the response to see what we're getting
        console.log('üîç Subscription API Response:', data);
        
        return data;
    } catch (err) {
        console.error('‚ùå Subscription fetch error:', err);
        return null;
    }
}

function getButton(p, sub) {
    const subscribed = sub?.subscribed === true;
    const current = sub?.current_plan || "none";
    
    // ‚úÖ FIXED: Use trial_eligible directly from API
    // If trial_eligible is false, they've already used it
    const trialEligible = sub?.trial_eligible !== false;
    
    // ‚úÖ DEBUG: Log button logic
    console.log(`üîç Button logic for ${p.id}:`, {
        subscribed,
        current,
        trial_eligible: sub?.trial_eligible,
        trial_used: sub?.trial_used,
        trialEligible
    });

    // If not subscribed
    if (!subscribed) {
        if (p.id === "free-trial") {
            if (!trialEligible) {
                return `<button class="btn btn-disabled">Trial Used</button>`;
            }
            return `<button class="btn btn-subscribe" onclick="subscribeNow('free-trial')">Start Free Trial</button>`;
        }
        return `<button class="btn btn-subscribe" onclick="subscribeNow('${p.id}')">Choose Plan</button>`;
    }

    // If currently on this plan
    if (
        (current === "trial" && p.id === "free-trial") ||
        (current === "basic" && p.id === "love-basic") ||
        (current === "plus" && p.id === "love-plus")
    ) {
        return `<button class="btn btn-disabled">Current Plan</button>`;
    }

    // Upgrade from trial
    if (current === "trial" && p.id !== "free-trial") {
        return `<button class="btn btn-subscribe" onclick="subscribeNow('${p.id}')">Upgrade Now</button>`;
    }

    // Upgrade from Basic to Plus
    if (current === "basic" && p.id === "love-plus") {
        return `<button class="btn btn-subscribe" onclick="subscribeNow('love-plus')">Upgrade Plan</button>`;
    }

    // Downgrade from Plus to Basic
    if (current === "plus" && p.id === "love-basic") {
        return `<button class="btn btn-subscribe" onclick="subscribeNow('love-basic')">Downgrade</button>`;
    }

    // Can't get trial again if already have a paid plan
    if (p.id === "free-trial") {
        return `<button class="btn btn-disabled">Unavailable</button>`;
    }

    return `<button class="btn btn-subscribe" onclick="subscribeNow('${p.id}')">Change Plan</button>`;
}

async function loadProducts() {
    const sub = await getSubscription();
    const grid = document.getElementById("productGrid");
    
    grid.innerHTML = "";

    Object.values(PRODUCTS).forEach(p => {
        if (p.subscription) {
            // Subscription card
            const featuredClass = p.featured ? ' featured' : '';
            const featuredBanner = p.featured ? '<div class="featured-banner">Best deal - Limited time only</div>' : '';
            const badge = p.badge ? `<div class="badge">${p.badge}</div>` : '';
            
            const featuresList = p.features 
                ? `<ul class="features-list">${p.features.map(f => `<li>${f}</li>`).join('')}</ul>`
                : '';

            grid.innerHTML += `
                <div class="card subscription-card${featuredClass}">
                    ${badge}
                    ${featuredBanner}
                    <div class="plan-name">${p.name}</div>
                    <div class="plan-description">${p.description}</div>
                    <div class="price-container">
                        <div class="price-main">
                            <span class="currency">US$</span>
                            <span class="amount">${p.price === 0 ? 'Free' : p.price.toFixed(2).replace('.00', '')}</span>
                            ${p.price > 0 ? '<span class="period">/mo</span>' : ''}
                        </div>
                        ${p.featured ? '<div class="bonus-text"></div>' : ''}
                        ${p.price > 0 ? `<div class="price-details">Renews at US$ ${p.price.toFixed(2)}/mo.</div>` : ''}
                    </div>
                    ${featuresList}
                    ${getButton(p, sub)}
                </div>
            `;
        } else {
            // Merch card
            const img = p.images
                ? `<div class="image-container">
                     <div class="product-tag">Merch</div>
                     <div class="dual-images">
                       <img src="${p.images[0]}" alt="${p.name}">
                       <img src="${p.images[1]}" alt="${p.name}">
                     </div>
                   </div>`
                : `<div class="image-container">
                     <div class="product-tag">Merch</div>
                     <img src="${p.image}" class="single-image" alt="${p.name}">
                   </div>`;

            grid.innerHTML += `
                <div class="card merch-card">
                    ${img}
                    <div class="name">${p.name}</div>
                    <div class="price">${p.price.toFixed(2)}</div>
                    <div class="product-billing">${p.billing}</div>
                    <button class="btn btn-add" onclick="addToCart('${p.id}')">Add to Cart</button>
                </div>
            `;
        }
    });
}

async function subscribeNow(productId) {
    try {
        const res = await fetch("/api/stripe/checkout", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ productId })
        });

        const data = await res.json();
        
        if (data.error?.includes("Not logged")) {
            window.location.href = "/login.html";
            return;
        }
        
        if (data.url) window.location.href = data.url;
    } catch (err) {
        console.error("Subscribe error:", err);
        alert("Error processing subscription. Please try again.");
    }
}

async function addToCart(id) {
    try {
        const p = PRODUCTS[id];

        const res = await fetch("/api/cart/add", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                productId: id,
                name: p.name,
                price: p.price
            })
        });

        const data = await res.json();

        if (data.error?.includes("Not logged")) {
            window.location.href = "/login.html";
            return;
        }

        if (data.success) {
            window.location.href = "/cart.html";
        } else {
            alert(data.error || "Error adding to cart");
        }
    } catch (err) {
        console.error("Add to cart error:", err);
        alert("Error adding to cart. Please try again.");
    }
}

document.addEventListener('DOMContentLoaded', loadProducts);
</script>

</body>
</html>